# =============================================================================
# Redis Security Configuration for Qwen2 Application
# =============================================================================
# This configuration provides enhanced security settings for Redis including
# authentication, access controls, network security, and operational security

# Network and Connection Security
# =============================================================================

# Bind to specific interfaces only (not all interfaces)
bind 127.0.0.1 172.20.3.0/24

# Disable protected mode (since we're using authentication)
protected-mode yes

# Default port (can be changed for security through obscurity)
port 6379

# TCP listen backlog
tcp-backlog 511

# Connection timeout (seconds)
timeout 300

# TCP keepalive
tcp-keepalive 300

# Authentication and Access Control
# =============================================================================

# Require authentication (password will be set via command line)
# requirepass will be set via --requirepass-file option

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_b835c3f8a5d2e7f1"
rename-command SHUTDOWN "SHUTDOWN_a7b9c2d4e6f8g1h3"
rename-command DEBUG ""
rename-command EVAL ""
rename-command SCRIPT ""

# ACL (Access Control List) configuration
# Enable ACL logging
acllog-max-len 128

# Default user configuration (disable default user)
user default off

# Create application user with limited permissions
user qwen-app on >qwen_app_password ~* &* -@dangerous +@read +@write +@string +@list +@set +@hash +@bitmap +@hyperloglog +@geo +@stream +@connection

# Memory and Performance Security
# =============================================================================

# Maximum memory usage (prevent memory exhaustion attacks)
maxmemory 512mb

# Memory eviction policy
maxmemory-policy allkeys-lru

# Disable memory overcommit (if supported by OS)
# This helps prevent OOM conditions

# Logging and Monitoring
# =============================================================================

# Log level (notice is good for production)
loglevel notice

# Log file location
logfile /var/log/redis/redis-server.log

# Enable syslog
syslog-enabled yes
syslog-ident redis-qwen

# Database and Persistence Security
# =============================================================================

# Number of databases (limit to reduce attack surface)
databases 4

# Save configuration (automatic snapshots)
save 900 1
save 300 10
save 60 10000

# Snapshot compression
rdbcompression yes

# Checksum for RDB files
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory
dir /data

# AOF (Append Only File) configuration for durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# Security-focused AOF settings
aof-rewrite-incremental-fsync yes

# Client Connection Security
# =============================================================================

# Maximum number of clients
maxclients 1000

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client query buffer limit
client-query-buffer-limit 1gb

# Protocol buffer limit
proto-max-bulk-len 512mb

# Slow Log Configuration
# =============================================================================

# Log queries slower than this (microseconds)
slowlog-log-slower-than 10000

# Maximum length of slow log
slowlog-max-len 128

# Latency Monitoring
# =============================================================================

# Enable latency monitoring
latency-monitor-threshold 100

# Security Hardening
# =============================================================================

# Disable Lua debugging
lua-debugger no

# Disable potentially dangerous Lua features
# (This is handled by command renaming above)

# Network Security
# =============================================================================

# Enable TLS (if certificates are available)
# tls-port 6380
# port 0
# tls-cert-file /etc/ssl/certs/redis.crt
# tls-key-file /etc/ssl/private/redis.key
# tls-ca-cert-file /etc/ssl/certs/ca.crt
# tls-protocols "TLSv1.2 TLSv1.3"

# Operational Security
# =============================================================================

# Disable crash reports
crash-log-enabled no
crash-memcheck-enabled no

# Set process title
set-proc-title yes

# Locale settings for security
locale-collate C

# Advanced Security Settings
# =============================================================================

# Tracking configuration
tracking-table-max-keys 1000000

# Stream configuration limits
stream-node-max-bytes 4096
stream-node-max-entries 100

# List configuration
list-max-ziplist-size -2
list-compress-depth 0

# Set configuration
set-max-intset-entries 512

# Hash configuration
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# Sorted set configuration
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog configuration
hll-sparse-max-bytes 3000

# Active rehashing
activerehashing yes

# Jemalloc background thread
jemalloc-bg-thread yes

# Disable active defragmentation in production for security
# activedefrag no

# Monitoring and Alerting Integration
# =============================================================================

# Enable keyspace notifications for monitoring
notify-keyspace-events "Ex"

# Replica configuration (if using replication)
# =============================================================================

# Replica read-only mode
replica-read-only yes

# Replica serve stale data
replica-serve-stale-data yes

# Replica priority
replica-priority 100

# Min replicas configuration for high availability
# min-replicas-to-write 1
# min-replicas-max-lag 10

# Security Notes and Recommendations
# =============================================================================
# 1. Always use authentication in production
# 2. Regularly rotate passwords
# 3. Monitor slow queries and unusual patterns
# 4. Use TLS for network encryption when possible
# 5. Implement proper firewall rules
# 6. Regular security audits and updates
# 7. Monitor memory usage and set appropriate limits
# 8. Use ACLs to limit user permissions
# 9. Disable or rename dangerous commands
# 10. Enable logging and monitoring