# =============================================================================
# Log Rotation Configuration for Qwen2 Docker Environment
# =============================================================================
# This configuration manages log rotation for all services to prevent
# disk space issues and maintain system performance.
# =============================================================================

# Global settings
compress
delaycompress
missingok
notifempty
create 644 root root
rotate 7
daily
maxage 30

# Application logs
/app/logs/*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 644 appuser appuser
    postrotate
        # Send HUP signal to application if running
        if [ -f /var/run/qwen-api.pid ]; then
            kill -HUP $(cat /var/run/qwen-api.pid) 2>/dev/null || true
        fi
    endscript
}

# API server logs
/app/logs/api/*.log {
    daily
    rotate 10
    compress
    delaycompress
    missingok
    notifempty
    size 100M
    create 644 appuser appuser
    postrotate
        # Restart API server gracefully if log file is too large
        echo "Log rotated at $(date)" >> /app/logs/api/rotation.log
    endscript
}

# Frontend logs (nginx)
/var/log/nginx/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 nginx nginx
    postrotate
        # Reload nginx configuration
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 $(cat /var/run/nginx.pid) 2>/dev/null || true
        fi
    endscript
}

# Traefik logs
/var/log/traefik/*.log {
    daily
    rotate 5
    compress
    delaycompress
    missingok
    notifempty
    size 50M
    create 644 root root
}

# GPU monitoring logs
/app/logs/gpu-memory.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    size 10M
    create 644 appuser appuser
}

# Cleanup logs
/app/logs/cleanup.log {
    weekly
    rotate 4
    compress
    delaycompress
    missingok
    notifempty
    size 50M
    create 644 appuser appuser
}

# Docker container logs (if accessible)
/var/lib/docker/containers/*/*.log {
    daily
    rotate 3
    compress
    delaycompress
    missingok
    notifempty
    size 100M
    copytruncate
    # Don't create new files as Docker manages these
    nocreate
}