<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DiffSynth Enhanced Image Editor</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          sans-serif;
      }
      .drag-drop-zone {
        border: 2px dashed #cbd5e0;
        transition: all 0.3s ease;
      }
      .drag-drop-zone:hover {
        border-color: #4299e1;
        background-color: #ebf8ff;
      }
      .drag-drop-zone.dragover {
        border-color: #3182ce;
        background-color: #bee3f8;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const API_BASE = "http://localhost:8000";

      function App() {
        const [mode, setMode] = useState("generate");
        const [prompt, setPrompt] = useState(
          "A beautiful sunset over mountains, digital art"
        );
        const [negativePrompt, setNegativePrompt] = useState(
          "blurry, low quality, distorted"
        );
        const [width, setWidth] = useState(512);
        const [height, setHeight] = useState(512);
        const [steps, setSteps] = useState(20);
        const [cfgScale, setCfgScale] = useState(7.0);
        const [strength, setStrength] = useState(0.8);
        const [isGenerating, setIsGenerating] = useState(false);
        const [status, setStatus] = useState("");
        const [generatedImage, setGeneratedImage] = useState(null);
        const [apiHealth, setApiHealth] = useState(null);
        const [inputImage, setInputImage] = useState(null);
        const [maskImage, setMaskImage] = useState(null);
        const [styleImage, setStyleImage] = useState(null);

        useEffect(() => {
          checkApiHealth();
        }, []);

        const checkApiHealth = async () => {
          try {
            console.log("Checking API health at:", `${API_BASE}/health`);
            const response = await fetch(`${API_BASE}/health`, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
              mode: "cors",
            });

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const health = await response.json();
            console.log("API health response:", health);
            setApiHealth(health);
          } catch (error) {
            console.error("API health check failed:", error);
            setApiHealth({ error: `API not available: ${error.message}` });
          }
        };

        const handleImageUpload = (file, type) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const base64 = e.target.result.split(",")[1];
            const imageData = { file, base64, url: e.target.result };

            if (type === "input") {
              setInputImage(imageData);
            } else if (type === "mask") {
              setMaskImage(imageData);
            } else if (type === "style") {
              setStyleImage(imageData);
            }
          };
          reader.readAsDataURL(file);
        };

        const handleDrop = (e, type) => {
          e.preventDefault();
          e.currentTarget.classList.remove("dragover");
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleImageUpload(files[0], type);
          }
        };

        const handleDragOver = (e) => {
          e.preventDefault();
          e.currentTarget.classList.add("dragover");
        };

        const handleDragLeave = (e) => {
          e.preventDefault();
          e.currentTarget.classList.remove("dragover");
        };

        const generateImage = async () => {
          setIsGenerating(true);
          setStatus(`Starting ${mode}...`);
          setGeneratedImage(null);

          try {
            let endpoint, payload;

            if (mode === "generate") {
              endpoint = `${API_BASE}/api/generate/text-to-image`;
              payload = {
                prompt,
                negative_prompt: negativePrompt,
                width,
                height,
                steps,
                cfg_scale: cfgScale,
                seed: 42,
              };
            } else {
              endpoint = `${API_BASE}/api/edit/image`;
              payload = {
                prompt,
                negative_prompt: negativePrompt,
                operation: mode,
                width,
                height,
                num_inference_steps: steps,
                guidance_scale: cfgScale,
                strength,
                seed: 42,
              };

              // Add image data based on mode
              if (inputImage) {
                payload.image_base64 = inputImage.base64;
              }

              if (mode === "inpaint" && maskImage) {
                payload.mask_base64 = maskImage.base64;
              }

              if (mode === "style_transfer" && styleImage) {
                payload.style_image_base64 = styleImage.base64;
                payload.style_strength = 0.7;
                payload.content_strength = 0.3;
              }

              if (mode === "outpaint") {
                payload.direction = "all";
                payload.pixels = 128;
              }
            }

            const response = await fetch(endpoint, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            const result = await response.json();

            if (result.job_id) {
              setStatus(`${mode} started! Monitoring progress...`);
              await pollForCompletion(result.job_id);
            } else {
              throw new Error(`Failed to start ${mode}`);
            }
          } catch (error) {
            setStatus(`Error: ${error.message}`);
          } finally {
            setIsGenerating(false);
          }
        };

        const pollForCompletion = async (jobId) => {
          const pollInterval = setInterval(async () => {
            try {
              const response = await fetch(`${API_BASE}/api/jobs/${jobId}`);
              const job = await response.json();

              if (!job) {
                clearInterval(pollInterval);
                setStatus("Job not found");
                return;
              }

              setStatus(
                `Status: ${job.status} (${(job.progress * 100).toFixed(0)}%)`
              );

              if (job.status === "completed") {
                clearInterval(pollInterval);
                setStatus(
                  `✅ ${mode} completed in ${job.result.processing_time?.toFixed(
                    1
                  )}s`
                );
                setGeneratedImage({
                  url: `${API_BASE}${job.result.image_url}`,
                  time: job.result.processing_time,
                });
              } else if (job.status === "failed") {
                clearInterval(pollInterval);
                setStatus(`❌ ${mode} failed: ${job.error}`);
              }
            } catch (error) {
              clearInterval(pollInterval);
              setStatus(`Error polling status: ${error.message}`);
            }
          }, 2000);
        };

        const ImageUploadZone = ({ type, image, label, description }) => (
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {label}
            </label>
            <div
              className="drag-drop-zone w-full h-32 rounded-lg flex items-center justify-center cursor-pointer"
              onDrop={(e) => handleDrop(e, type)}
              onDragOver={handleDragOver}
              onDragLeave={handleDragLeave}
              onClick={() => document.getElementById(`${type}-upload`).click()}
            >
              {image ? (
                <img
                  src={image.url}
                  alt={label}
                  className="max-h-full max-w-full object-contain"
                />
              ) : (
                <div className="text-center">
                  <p className="text-gray-500">{description}</p>
                  <p className="text-sm text-gray-400 mt-1">
                    Click or drag & drop
                  </p>
                </div>
              )}
            </div>
            <input
              id={`${type}-upload`}
              type="file"
              accept="image/*"
              className="hidden"
              onChange={(e) =>
                e.target.files[0] && handleImageUpload(e.target.files[0], type)
              }
            />
          </div>
        );

        const getModeDescription = () => {
          switch (mode) {
            case "generate":
              return "Create new images from text descriptions";
            case "edit":
              return "Edit existing images with text prompts";
            case "inpaint":
              return "Fill masked areas of images";
            case "outpaint":
              return "Extend images beyond their borders";
            case "style_transfer":
              return "Apply the style of one image to another";
            default:
              return "";
          }
        };

        const isInputRequired = () => mode !== "generate";
        const isMaskRequired = () => mode === "inpaint";
        const isStyleRequired = () => mode === "style_transfer";

        return (
          <div className="min-h-screen bg-gray-50 py-8">
            <div className="max-w-6xl mx-auto px-4">
              <div className="bg-white rounded-lg shadow-lg p-8">
                <h1 className="text-3xl font-bold text-gray-900 mb-8 text-center">
                  🎨 DiffSynth Enhanced Image Editor
                </h1>

                {/* API Status */}
                <div className="mb-6 p-4 rounded-lg bg-gray-100">
                  <h3 className="font-semibold mb-2">API Status:</h3>
                  {apiHealth ? (
                    apiHealth.error ? (
                      <span className="text-red-600">❌ {apiHealth.error}</span>
                    ) : (
                      <div className="space-y-1">
                        <div className="text-green-600">
                          ✅ {apiHealth.status}
                        </div>
                        <div className="text-sm text-gray-600">
                          DiffSynth:{" "}
                          {apiHealth.services?.diffsynth?.status || "unknown"} |
                          GPU:{" "}
                          {apiHealth.gpu?.available
                            ? "Available"
                            : "Not Available"}
                        </div>
                      </div>
                    )
                  ) : (
                    <span className="text-gray-600">Checking...</span>
                  )}
                </div>

                {/* Mode Selection */}
                <div className="mb-6">
                  <label className="block text-sm font-medium text-gray-700 mb-3">
                    Operation Mode
                  </label>
                  <div className="grid grid-cols-2 md:grid-cols-5 gap-2">
                    {[
                      {
                        value: "generate",
                        label: "🎨 Generate",
                        desc: "Text to Image",
                      },
                      {
                        value: "edit",
                        label: "✏️ Edit",
                        desc: "Image Editing",
                      },
                      {
                        value: "inpaint",
                        label: "🖌️ Inpaint",
                        desc: "Fill Areas",
                      },
                      {
                        value: "outpaint",
                        label: "🔍 Outpaint",
                        desc: "Extend Image",
                      },
                      {
                        value: "style_transfer",
                        label: "🎭 Style",
                        desc: "Style Transfer",
                      },
                    ].map((modeOption) => (
                      <button
                        key={modeOption.value}
                        onClick={() => setMode(modeOption.value)}
                        className={`p-3 rounded-lg text-center transition-colors ${
                          mode === modeOption.value
                            ? "bg-blue-600 text-white"
                            : "bg-gray-100 text-gray-700 hover:bg-gray-200"
                        }`}
                      >
                        <div className="font-semibold text-sm">
                          {modeOption.label}
                        </div>
                        <div className="text-xs mt-1">{modeOption.desc}</div>
                      </button>
                    ))}
                  </div>
                  <p className="text-sm text-gray-600 mt-2">
                    {getModeDescription()}
                  </p>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                  {/* Left Column - Controls */}
                  <div className="space-y-6">
                    {/* Image Uploads */}
                    {isInputRequired() && (
                      <ImageUploadZone
                        type="input"
                        image={inputImage}
                        label="Input Image"
                        description="Upload the image to edit"
                      />
                    )}

                    {isMaskRequired() && (
                      <ImageUploadZone
                        type="mask"
                        image={maskImage}
                        label="Mask Image"
                        description="Upload mask (white = inpaint area)"
                      />
                    )}

                    {isStyleRequired() && (
                      <ImageUploadZone
                        type="style"
                        image={styleImage}
                        label="Style Image"
                        description="Upload style reference image"
                      />
                    )}

                    {/* Prompt */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Prompt
                      </label>
                      <textarea
                        value={prompt}
                        onChange={(e) => setPrompt(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        rows="3"
                        placeholder="Describe what you want..."
                      />
                    </div>

                    {/* Negative Prompt */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Negative Prompt
                      </label>
                      <textarea
                        value={negativePrompt}
                        onChange={(e) => setNegativePrompt(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        rows="2"
                        placeholder="What to avoid..."
                      />
                    </div>

                    {/* Parameters */}
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Width
                        </label>
                        <input
                          type="number"
                          value={width}
                          onChange={(e) => setWidth(parseInt(e.target.value))}
                          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          min="256"
                          max="2048"
                          step="64"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Height
                        </label>
                        <input
                          type="number"
                          value={height}
                          onChange={(e) => setHeight(parseInt(e.target.value))}
                          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          min="256"
                          max="2048"
                          step="64"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Steps
                        </label>
                        <input
                          type="number"
                          value={steps}
                          onChange={(e) => setSteps(parseInt(e.target.value))}
                          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          min="10"
                          max="100"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          CFG Scale
                        </label>
                        <input
                          type="number"
                          value={cfgScale}
                          onChange={(e) =>
                            setCfgScale(parseFloat(e.target.value))
                          }
                          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          min="1.0"
                          max="20.0"
                          step="0.1"
                        />
                      </div>
                    </div>

                    {/* Strength (for editing modes) */}
                    {mode !== "generate" && (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Strength ({strength})
                        </label>
                        <input
                          type="range"
                          value={strength}
                          onChange={(e) =>
                            setStrength(parseFloat(e.target.value))
                          }
                          className="w-full"
                          min="0.1"
                          max="1.0"
                          step="0.1"
                        />
                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                          <span>Subtle</span>
                          <span>Strong</span>
                        </div>
                      </div>
                    )}

                    {/* Generate Button */}
                    <button
                      onClick={generateImage}
                      disabled={
                        isGenerating ||
                        (isInputRequired() && !inputImage) ||
                        (isMaskRequired() && !maskImage) ||
                        (isStyleRequired() && !styleImage)
                      }
                      className={`w-full py-4 px-6 rounded-lg font-semibold text-white transition-colors ${
                        isGenerating ||
                        (isInputRequired() && !inputImage) ||
                        (isMaskRequired() && !maskImage) ||
                        (isStyleRequired() && !styleImage)
                          ? "bg-gray-400 cursor-not-allowed"
                          : "bg-blue-600 hover:bg-blue-700"
                      }`}
                    >
                      {isGenerating
                        ? `🔄 Processing ${mode}...`
                        : `🎨 Start ${
                            mode.charAt(0).toUpperCase() + mode.slice(1)
                          }`}
                    </button>
                  </div>

                  {/* Right Column - Results */}
                  <div className="space-y-6">
                    {/* Status */}
                    {status && (
                      <div className="p-4 rounded-lg bg-blue-50 border border-blue-200">
                        <p className="text-blue-800">{status}</p>
                      </div>
                    )}

                    {/* Generated Image */}
                    {generatedImage && (
                      <div className="text-center">
                        <h3 className="text-xl font-semibold mb-4">Result</h3>
                        <img
                          src={generatedImage.url}
                          alt="Generated"
                          className="max-w-full mx-auto rounded-lg shadow-lg"
                        />
                        <p className="mt-4 text-gray-600">
                          Processing time: {generatedImage.time?.toFixed(1)}s
                        </p>
                        <div className="mt-4 space-x-2">
                          <a
                            href={generatedImage.url}
                            download="diffsynth-result.jpg"
                            className="inline-block px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                          >
                            📥 Download
                          </a>
                          <button
                            onClick={() =>
                              setInputImage({
                                url: generatedImage.url,
                                base64: generatedImage.url.split(",")[1],
                              })
                            }
                            className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                          >
                            🔄 Use as Input
                          </button>
                        </div>
                      </div>
                    )}

                    {/* Input Image Preview */}
                    {inputImage && (
                      <div className="text-center">
                        <h3 className="text-lg font-semibold mb-2">
                          Input Image
                        </h3>
                        <img
                          src={inputImage.url}
                          alt="Input"
                          className="max-w-full mx-auto rounded-lg shadow-md"
                        />
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
